# Deploying to Dokploy

This guide explains how to deploy this Symfony 7.4 + API Platform application to Dokploy.

## Overview

This project is a Symfony 7.4 application with:

- FrankenPHP (modern PHP application server)
- MariaDB 12.1.2 database
- Vite for frontend asset building
- API Platform for REST APIs
- Docker multi-stage builds for production

## Prerequisites

- A Dokploy instance set up and running
- A GitHub/GitLab repository with this code
- Domain name (optional, but recommended)

## Architecture

The application consists of:

- **App service**: FrankenPHP with PHP 8.4 (port 8080)
- **Database service**: MariaDB 12.1.2 (port 3306)

## Deployment Steps

### 1. Create a New Application in Dokploy

1. Log into your Dokploy dashboard
2. Click "Create Application"
3. Select "Docker" as the deployment type (not Docker Compose)
4. Choose your Git repository
5. Configure deployment trigger:
    - **Production**: Deploy on Git tag (e.g., `v1.0.0`, `v*`)
    - **Development**: Deploy on push to `develop` branch

### 2. Configure Build Settings

Dokploy will build directly from your Dockerfile when triggered. Configure the following:

**Dockerfile Path**: `./Dockerfile`

**Build Target**:

- **Production**: `prod`
- **Development**: `dev`
- **Staging**: `staging`

**Build Arguments** (optional):

```
BUILD_VERSION=1.0.0
BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
VCS_REF=$(git rev-parse HEAD)
```

The Dockerfile contains multiple stages:

- `dev` - Development with Xdebug and Node.js
- `integration` - For CI/CD pipelines
- `staging` - Pre-production environment
- `prod` - Optimized production build

**Deployment Triggers**:

- **Production app**: Builds on Git tags (e.g., create tag `v1.0.0` and push)
- **Development app**: Builds on every push to configured branch

### 3. Create a Database

1. In Dokploy, navigate to "Databases"
2. Click "Create Database" and select MariaDB
3. Configure:
    - **Name**: Choose a name (e.g., `app-db` or `myapp-production`)
    - **Version**: 12.1.2
    - **Database Name**: `app`
4. Click "Create" - Dokploy will auto-generate secure credentials
5. After creation, copy the connection details from the database overview:
    - **Internal Hostname** (e.g., `app-db` or similar)
    - **Username** (auto-generated)
    - **Password** (auto-generated)
    - **Database Name**
    - **Port** (default: 3306)

### 4. Environment Variables

Configure the following environment variables in your Dokploy application settings.

#### Required Variables

```env
# Application
APP_ENV=prod
APP_SECRET=<generate-a-random-32-char-secret>
APP_DEBUG=0

# Database - Copy credentials from Dokploy database GUI
# Format: mysql://USERNAME:PASSWORD@HOSTNAME:3306/DATABASE_NAME?serverVersion=12.1.2-MariaDB&charset=utf8mb4
DATABASE_URL=mysql://dokploy_user:auto_generated_password@app-db:3306/app?serverVersion=12.1.2-MariaDB&charset=utf8mb4

# Routing
DEFAULT_URI=https://yourdomain.com

# CORS (adjust based on your frontend domains)
CORS_ALLOW_ORIGIN='^https?://(yourdomain\.com|www\.yourdomain\.com)(:[0-9]+)?$'

# Server
SERVER_NAME=:8080
```

**Important**: Use the exact credentials copied from Dokploy's database overview. The username, password, and hostname
are auto-generated by Dokploy.

#### Optional Variables

```env
# Trusted Proxies (if behind Dokploy's reverse proxy)
SYMFONY_TRUSTED_PROXIES=127.0.0.1,REMOTE_ADDR

# Caddy/FrankenPHP tuning
CADDY_GLOBAL_OPTIONS=
CADDY_EXTRA_CONFIG=
CADDY_SERVER_LOG_OPTIONS=
CADDY_SERVER_EXTRA_DIRECTIVES=
FRANKENPHP_CONFIG=

# Database connection tuning
MAX_RETRIES=30
RETRY_INTERVAL=2
```

### 5. Configure Port Mapping

In Dokploy application settings:

- **Container Port**: `8080` (FrankenPHP listens on this port)

### 6. Configure Domain and SSL

1. In Dokploy, go to your application's "Domains" section
2. Add your domain name (e.g., `api.yourdomain.com`)
3. Enable SSL/TLS - Dokploy automatically provisions Let's Encrypt certificates
4. Save the configuration

### 7. Deploy

#### For Production (Tag-based deployment):

1. Ensure all changes are committed and pushed to your main branch
2. Create and push a Git tag:
   ```bash
   git tag v1.0.0
   git push origin v1.0.0
   ```
3. Dokploy detects the tag and starts building
4. Monitor the build logs in Dokploy's UI
5. Once deployed, the entrypoint script will:
    - Wait for database connection
    - Run Doctrine migrations automatically
    - Start FrankenPHP

#### For Development (Push-based deployment):

1. Push your code to the configured branch (e.g., `dev` or `develop`)
   ```bash
   git push origin develop
   ```
2. Dokploy automatically detects the push and starts building
3. Monitor the build logs in Dokploy's UI
4. The development environment will be updated automatically

### 8. Verify Deployment

Check that your application is running:

```bash
# Via Dokploy UI: Check container logs
# Or via CLI if you have access:
curl https://api.yourdomain.com
```

The API Platform welcome page should be accessible at your domain.

## Build Process

Dokploy builds your application directly from the Dockerfile on each push. The production build (`prod` target)
performs:

1. **Composer dependencies**: Installs production PHP packages with optimized autoloader
2. **Frontend assets**: Builds Vite assets for production
3. **Optimizations**:
    - Removes dev dependencies
    - Enables opcache via `docker/php/php-prod.ini`
    - Optimizes autoloader with classmap
    - Runs as non-root user (`www-data`)
4. **Multi-stage efficiency**: Only includes necessary files in final image

The build happens automatically on Dokploy's servers whenever you push to your repository.

## Database Migrations

The application automatically runs database migrations on startup via the entrypoint script (`docker-entrypoint.sh`):

1. Waits for database connection (max 30 attempts, 2s intervals)
2. Runs `doctrine:migrations:migrate --no-interaction`
3. Starts the application

If you need to skip auto-migrations, you can modify the entrypoint script.

## Health Checks

The application includes a built-in health check:

```yaml
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3
CMD curl -f http://localhost:2019/metrics || exit 1
```

This checks FrankenPHP's metrics endpoint to verify the application is running.

## Volumes and Persistence

### Database Persistence

The MariaDB database created in Dokploy automatically persists data using Docker volumes managed by Dokploy.

### Application Storage

- **Cache/logs**: Stored in `/app/var` within the container
- **Session data**: Stored in `/app/var/sessions`

For production, consider:

- Using Dokploy's volume management for persistent logs
- Configuring external log aggregation (e.g., Sentry, Datadog)
- Moving sessions to Redis for horizontal scaling

## Scaling Considerations

### Horizontal Scaling

To run multiple app instances in Dokploy:

1. The MariaDB database is already separate from the app container
2. Configure session storage to Redis/Memcached if needed
3. Set up shared file storage for uploads (if any)
4. Use Dokploy's built-in load balancing by increasing replicas

### Performance Tuning

Edit these files for production optimization:

- `docker/php/php-prod.ini` - PHP settings (opcache, memory limits)
- `docker/caddy/Caddyfile` - FrankenPHP/Caddy configuration

## Troubleshooting

### Container won't start

1. Check logs in Dokploy UI under "Logs" tab
2. Look for errors during the entrypoint script execution
3. Verify database hostname is correct in `DATABASE_URL`

### Database connection fails

Verify in Dokploy:

- Database service is running
- Database hostname matches what's configured in `DATABASE_URL`
- Credentials are correct
- Network connectivity between app and database

To test connection, use Dokploy's console/terminal feature:

```bash
php bin/console dbal:run-sql "SELECT 1"
```

### Migrations fail

Access the container via Dokploy's terminal feature and run:

```bash
php bin/console doctrine:migrations:migrate --no-interaction
```

Check for:

- Database permissions
- Table conflicts
- Migration file syntax errors

### 502 Bad Gateway

Check:

- Application container is running (check Dokploy dashboard)
- Container logs show FrankenPHP started successfully
- Health check passes: Look for health check status in Dokploy
- Port 8080 is correctly configured

### Build fails

Common issues:

- **Composer install fails**: Check `composer.json` syntax
- **npm build fails**: Verify `package.json` and Vite config
- **Docker build fails**: Check Dockerfile syntax and multi-stage dependencies

## Monitoring

Monitor your application via Dokploy:

1. **Application Logs**: Real-time logs in Dokploy UI
2. **Container Metrics**: CPU, memory, network usage in Dokploy dashboard
3. **FrankenPHP Metrics**: Available at internal `http://localhost:2019/metrics` (Prometheus format)
4. **Database Monitoring**: MariaDB metrics via Dokploy database dashboard

## Backup Strategy

### Database Backups

Dokploy provides built-in database backup features:

1. Navigate to your MariaDB database in Dokploy
2. Configure automatic backups (schedule and retention)
3. Or manually trigger backups via Dokploy UI

Manual backup via terminal (if needed):

```bash
# Access database terminal in Dokploy and run
mysqldump -u app_user -p app > backup.sql
```

### Application Backups

- **Code**: Versioned in Git repository
- **Container images**: Built automatically by Dokploy on each push
- **Data**: Only database requires regular backups
- **Configuration**: Environment variables stored in Dokploy

## Security Checklist

- [ ] Set strong `APP_SECRET` (32+ random characters)
- [ ] Copy auto-generated database credentials from Dokploy (already secure)
- [ ] Configure `SYMFONY_TRUSTED_PROXIES` correctly
- [ ] Set appropriate `CORS_ALLOW_ORIGIN`
- [ ] Disable `APP_DEBUG` in production (`APP_DEBUG=0`)
- [ ] Keep dependencies updated
- [ ] Enable HTTPS via Dokploy
- [ ] Configure automated database backups in Dokploy
- [ ] Monitor application logs for errors
- [ ] Use Git tags for production releases (never push directly to production)

## CI/CD with Dokploy

### Production Workflow (Tag-based)

Production deployments are triggered by Git tags for better release control:

1. Make code changes locally and test thoroughly
2. Commit and push to `main` branch
3. Create a version tag:
   ```bash
   git tag v1.0.1
   git push origin v1.0.1
   ```
4. Dokploy detects the tag and builds using `prod` target
5. Runs the new container
6. Entrypoint script runs migrations
7. Application is live with zero downtime

**Tag naming conventions**:

- Semantic versioning: `v1.0.0`, `v1.0.1`, `v2.0.0`
- Pre-releases: `v1.0.0-beta.1`, `v1.0.0-rc.1`

### Development Workflow (Push-based)

Development deployments happen automatically on every push:

1. Make code changes locally
2. Commit and push to `develop` branch:
   ```bash
   git push origin develop
   ```
3. Dokploy automatically builds using `dev` target
4. Development environment updates instantly

### Multi-Environment Setup

Set up separate Dokploy applications for each environment:

| Environment     | Trigger         | Branch    | Dockerfile Target | Domain                   |
|-----------------|-----------------|-----------|-------------------|--------------------------|
| **Production**  | Git tags (`v*`) | `main`    | `prod`            | `api.yourdomain.com`     |
| **Staging**     | Push            | `staging` | `staging`         | `staging.yourdomain.com` |
| **Development** | Push            | `develop` | `dev`             | `dev.yourdomain.com`     |

Each environment should have:

- Separate database instance in Dokploy
- Environment-specific variables
- Independent deployment configuration

## Additional Resources

- [Symfony Production Best Practices](https://symfony.com/doc/current/deployment.html)
- [FrankenPHP Documentation](https://frankenphp.dev/)
- [API Platform Deployment Guide](https://api-platform.com/docs/deployment/)
- [Dokploy Documentation](https://dokploy.com/docs)

## Support

For issues specific to:

- **Application code**: Check this repository's issue tracker
- **Dokploy platform**: Visit [Dokploy Discord](https://discord.gg/dokploy)
  or [GitHub](https://github.com/dokploy/dokploy)
- **Symfony**: See [Symfony documentation](https://symfony.com/doc)
